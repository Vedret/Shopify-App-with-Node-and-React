{"ast":null,"code":"var _regeneratorRuntime = require(\"/home/adiosamigos/Documents/NodeJs_Projects/Shopify_developer/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/home/adiosamigos/Documents/NodeJs_Projects/Shopify_developer/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nrequire('isomorphic-fetch'); //import \"@babel/polyfill\";\n\n\nvar dotenv = require('dotenv');\n\nvar _require = require('@shopify/koa-shopify-auth'),\n    verifyRequest = _require.verifyRequest;\n\nvar _require2 = require('@shopify/koa-shopify-auth'),\n    createShopifyAuth = _require2[\"default\"];\n\nvar _require3 = require('@shopify/shopify-api'),\n    Shopify = _require3[\"default\"],\n    ApiVersion = _require3.ApiVersion;\n\nvar Koa = require('koa');\n\nvar next = require('next');\n\nvar Router = require(\"koa-router\");\n\nvar session = require(\"koa-session\");\n\ndotenv.config();\nvar port = parseInt(process.env.PORT, 10) || 3000;\nvar dev = true;\nvar app = next({\n  dev: dev\n});\nvar handle = app.getRequestHandler();\nShopify.Context.initialize({\n  API_KEY: process.env.SHOPIFY_API_KEY,\n  API_SECRET_KEY: process.env.SHOPIFY_API_SECRET,\n  SCOPES: process.env.SHOPIFY_API_SCOPES.split(\",\"),\n  HOST_NAME: process.env.SHOPIFY_APP_URL.replace(/https:\\/\\//, \"\"),\n  API_VERSION: ApiVersion.October20,\n  IS_EMBEDDED_APP: true,\n  SESSION_STORAGE: new Shopify.Session.MemorySessionStorage()\n});\nvar ACTIVE_SHOPIFY_SHOPS = {};\napp.prepare().then(function () {\n  var server = new Koa();\n  var router = new Router();\n  server.keys = [Shopify.Context.API_SECRET_KEY];\n  server.use(createShopifyAuth({\n    afterAuth: function afterAuth(ctx) {\n      var _ctx$state$shopify = ctx.state.shopify,\n          shop = _ctx$state$shopify.shop,\n          scope = _ctx$state$shopify.scope;\n      ACTIVE_SHOPIFY_SHOPS[shop] = scope;\n      ctx.redirect(\"/?shop=\".concat(shop));\n    }\n  }));\n\n  var handleRequest = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx) {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return handle(ctx.req, ctx.res);\n\n            case 2:\n              ctx.respond = false;\n              ctx.res.statusCode = 200;\n\n            case 4:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function handleRequest(_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  router.get(\"/\", /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(ctx) {\n      var shop;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              shop = ctx.query.shop;\n\n              if (!(ACTIVE_SHOPIFY_SHOPS[shop] === undefined)) {\n                _context2.next = 5;\n                break;\n              }\n\n              ctx.redirect(\"/auth?shop=\".concat(shop));\n              _context2.next = 7;\n              break;\n\n            case 5:\n              _context2.next = 7;\n              return handleRequest(ctx);\n\n            case 7:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function (_x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }());\n  router.get(\"(/_next/static/.*)\", handleRequest);\n  router.get(\"/_next/webpack-hmr\", handleRequest);\n  router.get(\"(.*)\", verifyRequest(), handleRequest);\n  server.use(router.allowedMethods());\n  server.use(router.routes());\n  server.listen(port, function () {\n    console.log(\"> Ready on http://localhost:\".concat(port));\n  });\n});","map":{"version":3,"sources":["/home/adiosamigos/Documents/NodeJs_Projects/Shopify_developer/server.js"],"names":["require","dotenv","verifyRequest","createShopifyAuth","Shopify","ApiVersion","Koa","next","Router","session","config","port","parseInt","process","env","PORT","dev","app","handle","getRequestHandler","Context","initialize","API_KEY","SHOPIFY_API_KEY","API_SECRET_KEY","SHOPIFY_API_SECRET","SCOPES","SHOPIFY_API_SCOPES","split","HOST_NAME","SHOPIFY_APP_URL","replace","API_VERSION","October20","IS_EMBEDDED_APP","SESSION_STORAGE","Session","MemorySessionStorage","ACTIVE_SHOPIFY_SHOPS","prepare","then","server","router","keys","use","afterAuth","ctx","state","shopify","shop","scope","redirect","handleRequest","req","res","respond","statusCode","get","query","undefined","allowedMethods","routes","listen","console","log"],"mappings":"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","sourcesContent":["require('isomorphic-fetch');\n//import \"@babel/polyfill\";\nconst dotenv = require('dotenv');\nconst { verifyRequest } = require('@shopify/koa-shopify-auth');\nconst { default: createShopifyAuth } = require('@shopify/koa-shopify-auth');\nconst { default: Shopify, ApiVersion } = require('@shopify/shopify-api');\nconst Koa = require('koa');\nconst next = require('next');\nconst Router = require( \"koa-router\");\nconst session = require( \"koa-session\");\n\n\n\ndotenv.config();\nconst port = parseInt(process.env.PORT, 10) || 3000;\nconst dev = process.env.NODE_ENV !== \"production\";\nconst app = next({\n  dev,\n});\nconst handle = app.getRequestHandler();\n\nShopify.Context.initialize({\n    API_KEY: process.env.SHOPIFY_API_KEY,\n    API_SECRET_KEY: process.env.SHOPIFY_API_SECRET,\n    SCOPES: process.env.SHOPIFY_API_SCOPES.split(\",\"),\n    HOST_NAME: process.env.SHOPIFY_APP_URL.replace(/https:\\/\\//, \"\"),\n    API_VERSION: ApiVersion.October20,\n    IS_EMBEDDED_APP: true,\n    SESSION_STORAGE: new Shopify.Session.MemorySessionStorage(),\n  \n});\n\n\nconst ACTIVE_SHOPIFY_SHOPS = {};\n\napp.prepare().then(() => {\n    const server = new Koa();\n    const router = new Router();\n    server.keys = [Shopify.Context.API_SECRET_KEY];\n\n    server.use(\n        createShopifyAuth({\n          afterAuth(ctx) {\n            const { shop, scope } = ctx.state.shopify;\n            ACTIVE_SHOPIFY_SHOPS[shop] = scope;\n\n            ctx.redirect(`/?shop=${shop}`);\n     \n          },\n        }),\n      );\n  \n    const handleRequest = async (ctx) => {\n      await handle(ctx.req, ctx.res);\n      ctx.respond = false;\n      ctx.res.statusCode = 200;\n    };\n\n    router.get(\"/\", async (ctx) => {\n      const shop = ctx.query.shop;\n  \n      if (ACTIVE_SHOPIFY_SHOPS[shop] === undefined) {\n        ctx.redirect(`/auth?shop=${shop}`);\n      } else {\n        await handleRequest(ctx);\n      }\n    });\n\n   \n\n    \n    router.get(\"(/_next/static/.*)\", handleRequest);\n    router.get(\"/_next/webpack-hmr\", handleRequest);\n    router.get(\"(.*)\", verifyRequest(), handleRequest);\n  \n    server.use(router.allowedMethods());\n    server.use(router.routes());\n\n\n\n\n  server.listen(port, () => {\n    console.log(`> Ready on http://localhost:${port}`);\n  });\n});"]},"metadata":{},"sourceType":"script"}